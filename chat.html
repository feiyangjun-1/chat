<!DOCTYPE html>
<html>
<head>
    <title>加密对话</title>
    <style>
        body { font-family: Arial; max-width: 800px; margin: 20px auto; padding: 20px; }
        .hidden { display: none; }
        .chat-box { border: 1px solid #ddd; padding: 20px; margin: 20px 0; height: 400px; overflow-y: auto; }
        .message { margin: 10px; padding: 8px 12px; border-radius: 15px; max-width: 70%; }
        .received { background: #f1f0f0; float: left; clear: both; }
        .sent { background: #0084ff; color: white; float: right; clear: both; }
        input[type="password"], textarea { width: 100%; padding: 10px; margin: 5px 0; }
        button { background: #0084ff; color: white; border: none; padding: 10px 20px; cursor: pointer; }
    </style>
</head>
<body>
    <!-- 密码验证界面 -->
    <div id="authSection">
        <h2>进入加密对话</h2>
        <input type="password" id="inputPassword" placeholder="输入对话密码">
        <button onclick="initChat()">开始对话</button>
    </div>

    <!-- 聊天主界面 -->
    <div id="chatSection" class="hidden">
        <div class="chat-box" id="chatHistory"></div>
        <textarea id="inputMessage" placeholder="输入消息..."></textarea>
        <button onclick="sendMessage()">发送</button>
        <button onclick="copyChatLink()">分享对话链接</button>
    </div>

<script>
// 加密配置
const APP_SALT = 'chat@2023'; // 修改此值增强安全性
let currentSession = {
    id: null,
    password: null,
    messages: []
};

// 初始化对话
function initChat() {
    const password = document.getElementById('inputPassword').value;
    if (!password) return alert('请输入密码');
    
    // 处理URL参数
    const urlParams = new URLSearchParams(location.hash.substring(1));
    currentSession.id = urlParams.get('sid') || generateSessionId();
    currentSession.password = hashPassword(password);
    
    // 加载历史消息
    loadHistory();
    document.getElementById('authSection').classList.add('hidden');
    document.getElementById('chatSection').classList.remove('hidden');
    
    // 更新URL
    history.replaceState(null, null, `#sid=${currentSession.id}`);
}

// 生成会话ID
function generateSessionId() {
    return Math.random().toString(36).substr(2, 9);
}

// 密码哈希处理
function hashPassword(pwd) {
    return btoa(encodeURIComponent(pwd + APP_SALT)).split('').reverse().join('');
}

// 加密消息
function encryptMessage(text) {
    const raw = text + currentSession.password;
    return btoa(encodeURIComponent(raw).split('').reverse().join('');
}

// 解密消息
function decryptMessage(encrypted) {
    try {
        const decoded = decodeURIComponent(atob(encrypted.split('').reverse().join('')));
        return decoded.replace(currentSession.password, '');
    } catch {
        return "解密失败";
    }
}

// 发送消息
function sendMessage() {
    const input = document.getElementById('inputMessage');
    const text = input.value.trim();
    if (!text) return;
    
    // 加密存储
    const encrypted = encryptMessage(text);
    currentSession.messages.push({
        text: encrypted,
        time: new Date().toLocaleTimeString(),
        sent: true
    });
    
    saveHistory();
    input.value = '';
    renderMessages();
}

// 保存记录
function saveHistory() {
    const key = `chat_${currentSession.id}`;
    localStorage.setItem(key, JSON.stringify({
        passwordHash: currentSession.password,
        messages: currentSession.messages
    }));
}

// 加载记录
function loadHistory() {
    const key = `chat_${currentSession.id}`;
    const data = JSON.parse(localStorage.getItem(key));
    
    if (data && data.passwordHash === currentSession.password) {
        currentSession.messages = data.messages.map(msg => ({
            ...msg,
            text: decryptMessage(msg.text)
        }));
        renderMessages();
    }
}

// 渲染消息
function renderMessages() {
    const container = document.getElementById('chatHistory');
    container.innerHTML = currentSession.messages.map(msg => `
        <div class="message ${msg.sent ? 'sent' : 'received'}">
            <div>${msg.text}</div>
            <small>${msg.time}</small>
        </div>
    `).join('');
    container.scrollTop = container.scrollHeight;
}

// 分享链接
function copyChatLink() {
    const link = `${location.href.split('#')[0]}#sid=${currentSession.id}`;
    navigator.clipboard.writeText(link).then(() => {
        alert('链接已复制，发送给对话方');
    });
}

// URL变化监听
window.onhashchange = () => {
    if (location.hash.includes('sid=')) {
        document.getElementById('inputPassword').value = '';
        document.getElementById('authSection').classList.remove('hidden');
        document.getElementById('chatSection').classList.add('hidden');
    }
};
</script>
</body>
</html>
