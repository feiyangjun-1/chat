<!DOCTYPE html>
<html>
<head>
    <title>加密聊天</title>
    <style>
        body { font-family: Arial; max-width: 800px; margin: 20px auto; padding: 20px; }
        textarea { width: 100%; height: 100px; margin: 10px 0; padding: 10px; }
        button { background: #4CAF50; color: white; padding: 10px 20px; border: none; cursor: pointer; }
        .history { margin-top: 20px; border-top: 1px solid #ddd; padding-top: 15px; }
        .message { background: #f0f0f0; padding: 10px; margin: 5px 0; }
    </style>
</head>
<body>
    <h1>加密聊天（本地版）</h1>
    
    <!-- 发送消息区 -->
    <div id="sender">
        <textarea id="inputText" placeholder="输入要加密的消息"></textarea>
        <button onclick="encryptMessage()">生成加密链接</button>
        <div id="outputLink" style="margin-top: 15px;"></div>
    </div>

    <!-- 接收消息区 -->
    <div id="receiver" style="display: none;">
        <div class="message" id="decryptedMessage"></div>
        <button onclick="location.href='#'">返回</button>
    </div>

    <!-- 历史记录 -->
    <div class="history">
        <h3>历史记录</h3>
        <div id="historyList"></div>
    </div>

    <script>
        // 生成随机密钥（仅供演示，正式环境应使用更安全的方法）
        const secretKey = "mySecretKey12345"; // 修改这个密钥
        
        // 加密函数
        function encrypt(text) {
            return btoa(encodeURIComponent(text + secretKey).split('').reverse().join(''));
        }

        // 解密函数
        function decrypt(encrypted) {
            try {
                const decoded = decodeURIComponent(atob(encrypted).split('').reverse().join(''));
                return decoded.replace(secretKey, '');
            } catch {
                return "解密失败！";
            }
        }

        // 生成加密链接
        function encryptMessage() {
            const text = document.getElementById('inputText').value;
            if (!text) return alert("请输入内容");
            
            const encrypted = encrypt(text);
            const link = `${location.href}#${encrypted}`;
            
            // 显示链接
            document.getElementById('outputLink').innerHTML = `
                <p>分享链接：<input value="${link}" style="width:300px" readonly>
                <button onclick="copyLink('${link}')">复制</button></p >
            `;
            
            // 保存历史
            saveToHistory(link, text);
        }

        // 复制链接
        function copyLink(link) {
            navigator.clipboard.writeText(link).then(() => {
                alert("已复制到剪贴板");
            });
        }

        // 保存历史记录
        function saveToHistory(link, text) {
            const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            history.unshift({ link, text, date: new Date().toLocaleString() });
            localStorage.setItem('chatHistory', JSON.stringify(history));
            showHistory();
        }

        // 显示历史记录
        function showHistory() {
            const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            document.getElementById('historyList').innerHTML = history.map(item => `
                <div class="message">
                    <div>${item.date}</div>
                    <div>内容：${item.text}</div>
                    打开链接
                </div>
            `).join('');
        }

        // 初始化
        function init() {
            // 检查URL哈希
            if (location.hash) {
                const encrypted = location.hash.substring(1);
                document.getElementById('sender').style.display = 'none';
                document.getElementById('receiver').style.display = 'block';
                document.getElementById('decryptedMessage').innerText = decrypt(encrypted);
            }
            showHistory();
        }
        
        // 页面加载时运行
        window.onload = init;
    </script>
</body>
</html>